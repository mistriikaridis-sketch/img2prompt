<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debug Mode</title>
    <style>body{font-family:monospace;padding:20px;max-width:800px;margin:0 auto;}</style>
</head>
<body>
    <h1>ğŸ•µï¸â€â™‚ï¸ ä¾¦æ¢è°ƒè¯•æ¨¡å¼</h1>
    <p>è¯·ä¸Šä¼ å›¾ç‰‡ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæœåŠ¡å™¨çš„â€œåŸè¯â€ã€‚</p>
    <input type="file" id="file" onchange="testUpload(this.files[0])">
    <div id="status" style="margin-top:20px; padding:10px; background:#f0f0f0; border:1px solid #ccc; white-space: pre-wrap;">ç­‰å¾…ä¸Šä¼ ...</div>

    <script>
        async function testUpload(file) {
            const status = document.getElementById('status');
            if(!file) return;

            status.innerText = "â³ æ­£åœ¨å‹ç¼©å›¾ç‰‡...";
            const base64 = await compress(file);
            
            status.innerText = "ğŸš€ æ­£åœ¨å‘é€è¯·æ±‚ç»™åç«¯ /api/analyze ...";
            
            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ imageBase64: base64, style: 'general' })
                });

                status.innerText += `\n\nğŸ”µ HTTP çŠ¶æ€ç : ${res.status} ${res.statusText}`;

                // å…³é”®ï¼šå…ˆè¯»æ–‡æœ¬ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ HTML æŠ¥é”™é¡µ
                const rawText = await res.text();
                status.innerText += `\n\nğŸ“„ æœåŠ¡å™¨è¿”å›çš„åŸå§‹å†…å®¹:\n----------------\n${rawText.slice(0, 500)}${rawText.length>500?'...':''}\n----------------`;

                if (res.status !== 200) {
                    status.style.background = "#ffe6e6";
                    status.innerHTML += `\n\nâŒ <b style="color:red">å¤±è´¥åˆ†æï¼š</b>\n`;
                    if(res.status === 404) status.innerHTML += "Vercel æ‰¾ä¸åˆ° api/analyze.js æ–‡ä»¶ã€‚\n-> è¯·æ£€æŸ¥ Vercel Settings é‡Œçš„ Root Directory æ˜¯å¦ä¸ºç©ºã€‚\n-> è¯·æ£€æŸ¥ GitHub ä¸Š api æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ã€‚";
                    else if(res.status === 500) status.innerHTML += "åç«¯ä»£ç è¿è¡Œå‡ºé”™äº†ã€‚\n-> å¯èƒ½æ˜¯ä»£ç é‡Œçš„å­—ç¬¦å¤åˆ¶é”™äº†ï¼ˆæ¯”å¦‚æœ‰çœ‹ä¸è§çš„ç©ºæ ¼ï¼‰ï¼Œæˆ–è€… Key æœ‰é—®é¢˜ã€‚";
                    return;
                }

                // å°è¯•è§£æ JSON
                const data = JSON.parse(rawText);
                status.style.background = "#e6ffe6";
                status.innerText += `\n\nâœ… JSON è§£ææˆåŠŸ!\nPrompt: ${data.choices?.[0]?.message?.content || 'No content'}`;

            } catch (err) {
                status.style.background = "#ffe6e6";
                status.innerText += `\n\nğŸ’¥ å‰ç«¯æŠ¥é”™: ${err.message}`;
            }
        }

        function compress(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        let w=img.width, h=img.height;
                        if(w>h){if(w>800){h*=800/w;w=800}}else{if(h>800){w*=800/h;h=800}}
                        c.width=w;c.height=h;
                        ctx.drawImage(img,0,0,w,h);
                        r(c.toDataURL('image/jpeg',0.6));
                    };
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
